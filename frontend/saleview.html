<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>à¸£à¸°à¸šà¸šà¸šà¸±à¸™à¸—à¸¶à¸à¸¢à¸­à¸”à¸‚à¸²à¸¢</title>
   <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3588/3588658.png" type="image/png" />
  <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <h1>ğŸ“Š à¸£à¸°à¸šà¸šà¸šà¸±à¸™à¸—à¸¶à¸à¸¢à¸­à¸”à¸‚à¸²à¸¢à¸£à¸²à¸¢à¸§à¸±à¸™</h1>
  <a href="index.html" class="back">â† à¸à¸¥à¸±à¸šà¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</a>
  <!-- ğŸ”§ Tools -->
  <div class="toolbar">
    <button onclick="openPopup()">â• Add</button>
    <button id="edit-btn" disabled>âœï¸ Edit</button>
    <button id="delete-btn" disabled onclick="deleteEntry()">âŒ Cancel</button>
	<button id="theme-toggle">ğŸŒ™</button></div>
<div>
    <label>à¸ˆà¸²à¸ <input type="date" id="startDate" onchange="loadSales()"></label>
    <label>à¸–à¸¶à¸‡ <input type="date" id="endDate" onchange="loadSales()"></label>
	</div>
  <!-- ğŸ“‹ Sales Table -->
  <div id="sales-list"></div>

  <!-- ğŸ“ Add Popup -->
  <div id="popup" class="popup hidden">
    <div class="popup-content">
      <h2>à¹€à¸à¸´à¹ˆà¸¡à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸­à¸”à¸‚à¸²à¸¢</h2>
      <form id="add-form">
        <label>ğŸ“… à¸§à¸±à¸™à¸—à¸µà¹ˆ <input type="date" name="date" required></label>
        <label>ğŸ§´ Staff Oil (à¸šà¸²à¸—) <input type="number" name="staffOil" step="0.01"></label>
        <label>ğŸ‘¥ Customers (à¸„à¸™) <input type="number" name="customers"></label>
        <label>ğŸ’° Total income (à¸šà¸²à¸—) <input type="number" name="income" step="0.01"></label>
        <label>ğŸ“ˆ Commission <input type="number" name="commission" step="0.01"></label>
        <label>ğŸ’¹ Extra Commission <input type="number" name="extraCommission" step="0.01"></label>
        <label>ğŸ’¸ Expense <input type="number" name="expense" step="0.01"></label>
        <label>ğŸ’³ Credit Card <input type="number" name="creditCard" step="0.01" oninput="updateTotalPreview()"></label>
        <label>ğŸ“Š Total Credit Card <input type="number" id="totalCreditPreview" disabled></label>
        <label>ğŸ’µ Cash <input type="number" name="cash" step="0.01" oninput="updateTotalPreview()"></label>
        <label>ğŸ“Š Total Cash <input type="number" id="totalCashPreview" disabled></label>
        <label>ğŸ•“ à¹€à¸§à¸¥à¸²à¹€à¸›à¸´à¸” <input type="time" name="timeOpen"></label>
		<label>ğŸ•• à¹€à¸§à¸¥à¸²à¸›à¸´à¸” <input type="time" name="timeClose"></label>


        <button type="submit">ğŸ’¾ à¸šà¸±à¸™à¸—à¸¶à¸</button>
        <button type="button" onclick="closePopup()">âŒ à¸¢à¸à¹€à¸¥à¸´à¸</button>
      </form>
    </div>
  </div>
  
<script type="module">
    const themeToggle = document.getElementById('theme-toggle');
    const darkMode = localStorage.getItem('darkMode') === 'true';
    if (darkMode) document.documentElement.classList.add('dark');
    themeToggle.innerText = darkMode ? 'â˜€ï¸' : 'ğŸŒ™';
    themeToggle.onclick = () => {
      const isDark = document.documentElement.classList.toggle('dark');
      themeToggle.innerText = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
      localStorage.setItem('darkMode', isDark);
    };

  import { 
  getFirestore, collection, query, where, getDocs, orderBy, Timestamp, 
  addDoc, deleteDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";


  const firebaseConfig = {
    apiKey: "AIzaSyBERm0hDUs3V0G3DtcJYkZL_rR83JOQZcA",
    authDomain: "ubmassage-cf36d.firebaseapp.com",
    projectId: "ubmassage-cf36d",
    storageBucket: "ubmassage-cf36d.appspot.com",
    messagingSenderId: "720673357275",
    appId: "1:720673357275:web:376c713ffae847eb233bfe",
    measurementId: "G-EHKL6JM0TJ"
  };

function openPopup() {
  document.getElementById("popup").classList.remove("hidden");
}

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  signInAnonymously(auth).catch(console.error);

  let selectedId = null;

  // à¹‚à¸«à¸¥à¸”à¸¢à¸­à¸”à¸‚à¸²à¸¢à¸•à¸²à¸¡à¸§à¸±à¸™à¸—à¸µà¹ˆ
  async function loadSales() {
    clearSelection();
    const listEl = document.getElementById("sales-list");
    listEl.innerHTML = "â³ à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...";

    const startDateInput = document.getElementById("startDate").value;
    const endDateInput = document.getElementById("endDate").value;
    if (!startDateInput || !endDateInput) {
      listEl.innerHTML = "<p>à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸Šà¹ˆà¸§à¸‡à¸§à¸±à¸™à¸—à¸µà¹ˆà¹ƒà¸«à¹‰à¸„à¸£à¸š</p>";
      return;
    }

    const startDate = new Date(startDateInput);
    const endDate = new Date(endDateInput);
    endDate.setHours(23, 59, 59, 999);

    // à¸ªà¸£à¹‰à¸²à¸‡ Query
    const salesRef = collection(db, "sales");
    const q = query(
      salesRef,
      where("date", ">=", Timestamp.fromDate(startDate)),
      where("date", "<=", Timestamp.fromDate(endDate)),
      orderBy("date", "asc")
    );

    const snapshot = await getDocs(q);

    if (snapshot.empty) {
      listEl.innerHTML = "<p>à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥</p>";
      return;
    }

    let html = `<table class="sales-table"><thead><tr>
      <th>ğŸ“… à¸§à¸±à¸™à¸—à¸µà¹ˆ</th><th>ğŸ§´ Staff Oil</th><th>ğŸ‘¥ Customers</th><th>ğŸ’° Income</th>
      <th>ğŸ“ˆ Commission</th><th>ğŸ’¹ Extra</th><th>ğŸ’¸ Expense</th><th>ğŸ’³ Credit</th>
      <th>ğŸ§® Total Credit</th><th>ğŸ’µ Cash</th><th>ğŸ§® Total Cash</th><th>â±ï¸ à¹€à¸§à¸¥à¸²</th>
    </tr></thead><tbody>`;

    let totalCredit = 0;
    let totalCash = 0;

    snapshot.forEach(docSnap => {
      const d = docSnap.data();
      const dateStr = d.date.toDate().toLocaleDateString("th-TH");
      totalCredit += d.creditCard || 0;
      totalCash += d.cash || 0;

      html += `<tr onclick="selectEntry(this)" data-id="${docSnap.id}">
        <td>${dateStr}</td>
        <td>${formatMoney(d.staffOil)}</td>
        <td>${d.customers}</td>
        <td>${formatMoney(d.income)}</td>
        <td>${formatMoney(d.commission)}</td>
        <td>${formatMoney(d.extraCommission)}</td>
        <td>${formatMoney(d.expense)}</td>
        <td>${formatMoney(d.creditCard)}</td>
        <td><b>${formatMoney(totalCredit)}</b></td>
        <td>${formatMoney(d.cash)}</td>
        <td><b>${formatMoney(totalCash)}</b></td>
        <td>${d.timeWork || "-"}</td>
      </tr>`;
    });

    html += `</tbody></table>`;
    listEl.innerHTML = html;
  }

  function formatMoney(num) {
    return (num || 0).toLocaleString("th-TH", { minimumFractionDigits: 2 });
  }

  function clearSelection() {
    document.getElementById("edit-btn").disabled = true;
    document.getElementById("delete-btn").disabled = true;
    selectedId = null;
  }

	function selectEntry(row) {
		document.querySelectorAll("tbody tr").forEach(tr => tr.classList.remove("selected")); // fix à¸•à¸£à¸‡à¸™à¸µà¹‰
		row.classList.add("selected");
		document.getElementById("edit-btn").disabled = false;
		document.getElementById("delete-btn").disabled = false;
		selectedId = row.getAttribute("data-id");
	}
	
	function closePopup() {
  document.getElementById("popup").classList.add("hidden");
  const form = document.getElementById("add-form");
  form.reset();
  form.removeAttribute("data-editing");
}

  async function deleteEntry() {
    if (!selectedId) return;
    if (confirm("à¸„à¸¸à¸“à¹à¸™à¹ˆà¹ƒà¸ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆà¸§à¹ˆà¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¥à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¸™à¸µà¹‰?")) {
      await deleteDoc(doc(db, "sales", selectedId));
      loadSales();
      clearSelection();
    }
  }

function updateTotalPreview() {
  const creditCard = parseFloat(document.querySelector("input[name='creditCard']").value) || 0;
  const cash = parseFloat(document.querySelector("input[name='cash']").value) || 0;

  document.getElementById("totalCreditPreview").value = creditCard.toLocaleString("th-TH", {minimumFractionDigits: 2});
  document.getElementById("totalCashPreview").value = cash.toLocaleString("th-TH", {minimumFractionDigits: 2});
}


  document.getElementById("add-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const form = e.target;
  const submitBtn = form.querySelector("button[type='submit']");
  submitBtn.disabled = true;

  const timeOpen = form.timeOpen.value;
  const timeClose = form.timeClose.value;
  const timeWork = (timeOpen && timeClose) ? `${timeOpen} - ${timeClose}` : "-";

  const data = {
    date: Timestamp.fromDate(new Date(form.date.value)),
    staffOil: parseFloat(form.staffOil.value) || 0,
    customers: parseInt(form.customers.value) || 0,
    income: parseFloat(form.income.value) || 0,
    commission: parseFloat(form.commission.value) || 0,
    extraCommission: parseFloat(form.extraCommission.value) || 0,
    expense: parseFloat(form.expense.value) || 0,
    creditCard: parseFloat(form.creditCard.value) || 0,
    cash: parseFloat(form.cash.value) || 0,
    timeWork: timeWork
  };

  try {
    if (form.getAttribute("data-editing") === "true" && selectedId) {
      const docRef = doc(db, "sales", selectedId);
      await setDoc(docRef, data); // à¹à¸à¹‰à¹„à¸‚à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸”à¸´à¸¡
    } else {
      await addDoc(collection(db, "sales"), data); // à¹€à¸à¸´à¹ˆà¸¡à¹ƒà¸«à¸¡à¹ˆ
    }

    closePopup();
    loadSales();
    clearSelection();
  } catch (error) {
    alert("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥: " + error.message);
  } finally {
    submitBtn.disabled = false;
    form.removeAttribute("data-editing");
  }
});

  

  window.loadSales = loadSales;
  window.selectEntry = selectEntry;
  window.deleteEntry = deleteEntry;
  window.openPopup = openPopup;
  window.closePopup = closePopup;
  window.updateTotalPreview = updateTotalPreview;

  // à¹‚à¸«à¸¥à¸”à¸„à¸£à¸±à¹‰à¸‡à¹à¸£à¸
window.onload = () => {
  const now = new Date();

  // à¸«à¸²à¸„à¹ˆà¸²à¹€à¸§à¸¥à¸²à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¹ƒà¸™ UTC+7
  // à¸„à¸³à¸™à¸§à¸“à¹€à¸§à¸¥à¸² UTC à¸‚à¸­à¸‡à¸•à¸­à¸™à¸™à¸µà¹‰
  const utc = new Date(now.getTime() + now.getTimezoneOffset() * 60000);

  // à¹€à¸§à¸¥à¸² UTC+7 à¸„à¸·à¸­ UTC + 7 à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡
  const thailandTime = new Date(utc.getTime() + 7 * 60 * 60000);

  // à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸”à¸·à¸­à¸™ = à¸§à¸±à¸™à¸—à¸µà¹ˆ 1 à¹€à¸§à¸¥à¸² 00:00 à¹ƒà¸™ UTC+7
  const firstDay = new Date(thailandTime.getFullYear(), thailandTime.getMonth(), 1);

  // à¸§à¸±à¸™à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢à¸‚à¸­à¸‡à¹€à¸”à¸·à¸­à¸™ = à¸§à¸±à¸™à¸à¹ˆà¸­à¸™à¸§à¸±à¸™à¹à¸£à¸à¸‚à¸­à¸‡à¹€à¸”à¸·à¸­à¸™à¸–à¸±à¸”à¹„à¸› à¹€à¸§à¸¥à¸² 23:59:59 à¹ƒà¸™ UTC+7
  const lastDay = new Date(thailandTime.getFullYear(), thailandTime.getMonth() + 1, 0);

  // à¹à¸›à¸¥à¸‡à¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™ string yyyy-MM-dd (à¸‹à¸¶à¹ˆà¸‡à¸ˆà¸°à¹€à¸›à¹‡à¸™à¹€à¸§à¸¥à¸²à¸—à¹‰à¸­à¸‡à¸–à¸´à¹ˆà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡)
  // à¹à¸•à¹ˆà¹€à¸£à¸²à¸•à¹‰à¸­à¸‡à¹à¸›à¸¥à¸‡à¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™ ISO String à¹ƒà¸™à¹‚à¸‹à¸™ UTC+7 à¸”à¹‰à¸§à¸¢à¸§à¸´à¸˜à¸µà¸™à¸µà¹‰:
  const toDateInputString = (date) => {
    // à¸ªà¸£à¹‰à¸²à¸‡ string à¹ƒà¸™à¸£à¸¹à¸›à¹à¸šà¸š yyyy-MM-dd à¸ªà¸³à¸«à¸£à¸±à¸š input type=date à¹‚à¸”à¸¢à¹ƒà¸Šà¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸§à¸±à¸™-à¹€à¸”à¸·à¸­à¸™-à¸›à¸µà¸‚à¸­à¸‡ date
    const y = date.getFullYear();
    const m = (date.getMonth() + 1).toString().padStart(2, "0");
    const d = date.getDate().toString().padStart(2, "0");
    return `${y}-${m}-${d}`;
  };

  document.getElementById("startDate").value = toDateInputString(firstDay);
  document.getElementById("endDate").value = toDateInputString(lastDay);

  loadSales();
};

 

document.getElementById("edit-btn").addEventListener("click", async () => {
  if (!selectedId) return;

  const docRef = doc(db, "sales", selectedId);
  const docSnap = await getDoc(docRef);

  if (!docSnap.exists()) {
    alert("à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¸²à¸¢à¸à¸²à¸£à¸™à¸µà¹‰");
    return;
  }

  const data = docSnap.data();

  const form = document.getElementById("add-form");

  form.date.value = data.date.toDate().toISOString().split("T")[0];
  form.staffOil.value = data.staffOil || "";
  form.customers.value = data.customers || "";
  form.income.value = data.income || "";
  form.commission.value = data.commission || "";
  form.extraCommission.value = data.extraCommission || "";
  form.expense.value = data.expense || "";
  form.creditCard.value = data.creditCard || "";
  form.cash.value = data.cash || "";
  
  if (data.timeWork && data.timeWork.includes("-")) {
  const parts = data.timeWork.split(" - ");
  form.timeOpen.value = parts[0] ? parts[0].trim() : "";
  form.timeClose.value = parts[1] ? parts[1].trim() : "";
} else {
  form.timeOpen.value = "";
  form.timeClose.value = "";
}


  form.setAttribute("data-editing", "true");
  openPopup();
});


</script>
</body>
</html>
