<!DOCTYPE html>
<html lang="th">
<head>
Â <meta charset="UTF-8">
Â <title>à¸£à¸°à¸šà¸šà¸šà¸±à¸™à¸—à¸¶à¸à¸¢à¸­à¸”à¸‚à¸²à¸¢</title>
Â <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3588/3588658.png" type="image/png" />
Â <link rel="stylesheet" href="style.css">
Â <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet">
Â <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
Â <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
Â <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
Â <h1>ğŸ“Š à¸£à¸°à¸šà¸šà¸šà¸±à¸™à¸—à¸¶à¸à¸¢à¸­à¸”à¸‚à¸²à¸¢à¸£à¸²à¸¢à¸§à¸±à¸™</h1>
Â <a href="index.html" class="back">â† à¸à¸¥à¸±à¸šà¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</a>
Â 
Â <div class="toolbar">
Â  <button onclick="openPopup()">â• à¹€à¸à¸´à¹ˆà¸¡</button>
Â  <button id="edit-btn" disabled>âœï¸ à¹à¸à¹‰à¹„à¸‚</button>
Â  <button id="delete-btn" disabled onclick="deleteEntry()">âŒ à¸¥à¸š</button>
Â  <button id="export-pdf">à¸ªà¹ˆà¸‡à¸­à¸­à¸ PDF</button>
Â  <button id="export-excel">à¸ªà¹ˆà¸‡à¸­à¸­à¸ Excel</button>
Â  <button id="theme-toggle">ğŸŒ™</button>
Â </div>

Â <div class="date-range">
Â  <label>à¸›à¸µ: <input type="number" id="year" value="2025" min="2000"></label>
Â  <label>à¸ˆà¸²à¸à¹€à¸”à¸·à¸­à¸™: <select id="startMonth"></select></label>
Â  <label>à¸–à¸¶à¸‡à¹€à¸”à¸·à¸­à¸™: <select id="endMonth"></select></label>
Â  <button id="load-data-btn">à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥</button>
Â </div>

Â <div id="sales-list">
Â  Â <table class="sales-table">
Â  Â  Â <thead>
Â  Â  Â  Â <tr>
Â  Â  Â  Â  Â <th>ğŸ“… à¸§à¸±à¸™à¸—à¸µà¹ˆ</th>
Â  Â  Â  Â  Â <th>ğŸ§´ Staff Oil</th>
Â  Â  Â  Â  Â <th>ğŸ‘¥ à¸¥à¸¹à¸à¸„à¹‰à¸²</th>
Â  Â  Â  Â  Â <th>ğŸ’° à¸£à¸²à¸¢à¸£à¸±à¸š</th>
Â  Â  Â  Â  Â <th>ğŸ“ˆ à¸„à¹ˆà¸²à¸¡à¸·à¸­</th>
Â  Â  Â  Â  Â <th>ğŸ’¹ à¸„à¹ˆà¸²à¸¡à¸·à¸­à¸à¸´à¹€à¸¨à¸©</th>
Â  Â  Â  Â  Â <th>ğŸ’¸ à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢</th>
Â  Â  Â  Â  Â <th>ğŸ’³ à¸šà¸±à¸•à¸£à¹€à¸„à¸£à¸”à¸´à¸•</th>
Â  Â  Â  Â  Â <th>ğŸ’µ à¹€à¸‡à¸´à¸™à¸ªà¸”</th>
Â  Â  Â  Â  Â <th>ğŸ“ˆ à¸¢à¸­à¸”à¸ªà¸¸à¸—à¸˜à¸´</th>
Â  Â  Â  Â  Â <th>â±ï¸ à¹€à¸§à¸¥à¸²à¸—à¸³à¸‡à¸²à¸™</th>
Â  Â  Â  Â </tr>
Â  Â  Â </thead>
Â  Â  Â <tbody id="sales-table-body">
Â  Â  Â  Â Â  Â  Â </tbody>
Â  Â </table>
Â </div>

<div class="summary-container" id="sales-summary">
    <h3>à¸ªà¸£à¸¸à¸›à¸¢à¸­à¸”à¸£à¸§à¸¡</h3>
    <table class="summary-table">
        <tbody>
            <tr>
                <th>à¸¢à¸­à¸”à¸£à¸§à¸¡à¸¥à¸¹à¸à¸„à¹‰à¸²</th>
                <td id="summary-customers">0 à¸„à¸™</td>
            </tr>
            <tr>
                <th>à¸¢à¸­à¸”à¸£à¸§à¸¡à¸£à¸²à¸¢à¸£à¸±à¸šà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</th>
                <td id="summary-income">0.00</td>
            </tr>
            <tr>
                <th>à¸¢à¸­à¸”à¸£à¸§à¸¡à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</th>
                <td id="summary-expense">0.00</td>
            </tr>
            <tr>
                <th>à¸¢à¸­à¸”à¸£à¸§à¸¡à¸ªà¸¸à¸—à¸˜à¸´</th>
                <td id="summary-net-income">0.00</td>
            </tr>
            <tr>
                <th>à¸¢à¸­à¸”à¸£à¸§à¸¡à¸šà¸±à¸•à¸£à¹€à¸„à¸£à¸”à¸´à¸•à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</th>
                <td id="summary-credit-card">0.00</td>
            </tr>
            <tr>
                <th>à¸¢à¸­à¸”à¸£à¸§à¸¡à¹€à¸‡à¸´à¸™à¸ªà¸”à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</th>
                <td id="summary-cash">0.00</td>
            </tr>
        </tbody>
    </table>
</div>

Â <div id="popup" class="popup hidden">
Â  <div class="popup-content">
Â  <h2>à¹€à¸à¸´à¹ˆà¸¡à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸­à¸”à¸‚à¸²à¸¢</h2>
Â  <form id="add-form">
Â  Â <label>ğŸ“… à¸§à¸±à¸™à¸—à¸µà¹ˆ <input type="date" name="date" required></label>
Â  Â <label>ğŸ§´ Staff Oil (à¸šà¸²à¸—) <input type="number" name="staffOil" step="0.01"></label>
Â  Â <label>ğŸ‘¥ Customers (à¸„à¸™) <input type="number" name="customers"></label>
Â  Â <label>ğŸ’° Total income (à¸šà¸²à¸—) <input type="number" name="income" step="0.01" oninput="updateTotalPreview()"></label>
Â  Â <label>ğŸ“ˆ Commission <input type="number" name="commission" step="0.01"></label>
Â  Â <label>ğŸ’¹ Extra Commission <input type="number" name="extraCommission" step="0.01"></label>
Â  Â <label>ğŸ’¸ Expense <input type="number" name="expense" step="0.01" oninput="updateTotalPreview()"></label>
Â  Â <label>ğŸ’³ Credit Card <input type="number" name="creditCard" step="0.01" oninput="updateTotalPreview()"></label>
Â  Â <label>ğŸ’µ Cash <input type="number" name="cash" step="0.01" oninput="updateTotalPreview()"></label>
Â  Â <label>ğŸ“Š à¸¢à¸­à¸”à¸£à¸§à¸¡à¸ªà¸¸à¸—à¸˜à¸´ <input type="text" id="netIncomePreview" disabled></label>
Â  Â <label>ğŸ“Š à¸¢à¸­à¸”à¸£à¸§à¸¡à¸£à¸±à¸š <input type="text" id="totalPreview" disabled></label>
Â  Â <label>ğŸ•“ à¹€à¸§à¸¥à¸²à¹€à¸›à¸´à¸” <input type="time" name="timeOpen"></label>
Â  Â <label>ğŸ•• à¹€à¸§à¸¥à¸²à¸›à¸´à¸” <input type="time" name="timeClose"></label>

Â  Â <button type="submit">ğŸ’¾ à¸šà¸±à¸™à¸—à¸¶à¸</button>
Â  Â <button type="button" onclick="closePopup()">âŒ à¸¢à¸à¹€à¸¥à¸´à¸</button>
Â  </form>
Â  </div>
Â </div>
Â 
<script>
Â  Â  // ** URL Backend à¸—à¸µà¹ˆ Deploy à¸šà¸™ Render **
Â  Â  const RENDER_BACKEND_URL = 'https://ub-backend.onrender.com';

Â  Â  // Theme toggle
Â  Â  const themeToggle = document.getElementById('theme-toggle');
Â  Â  const darkMode = localStorage.getItem('darkMode') === 'true';
Â  Â  if (darkMode) document.documentElement.classList.add('dark');
Â  Â  themeToggle.innerText = darkMode ? 'â˜€ï¸' : 'ğŸŒ™';
Â  Â  themeToggle.onclick = () => {
Â  Â  Â  Â  const isDark = document.documentElement.classList.toggle('dark');
Â  Â  Â  Â  themeToggle.innerText = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
Â  Â  Â  Â  localStorage.setItem('darkMode', isDark);
Â  Â  };

Â  Â  let selectedId = null;
Â  Â  let currentSalesData = []; // Store fetched data for export

Â  Â  function openPopup() {
Â  Â  Â  Â  document.getElementById("popup").classList.remove("hidden");
Â  Â  }

Â  Â  function closePopup() {
Â  Â  Â  Â  document.getElementById("popup").classList.add("hidden");
Â  Â  Â  Â  const form = document.getElementById("add-form");
Â  Â  Â  Â  form.reset();
Â  Â  Â  Â  form.removeAttribute("data-editing");
Â  Â  Â  Â  selectedId = null; // Clear selected ID when closing
Â  Â  }

Â  Â  function clearSelection() {
Â  Â  Â  Â  document.querySelectorAll("tbody tr").forEach(tr => tr.classList.remove("selected"));
Â  Â  Â  Â  document.getElementById("edit-btn").disabled = true;
Â  Â  Â  Â  document.getElementById("delete-btn").disabled = true;
Â  Â  Â  Â  selectedId = null;
Â  Â  }

Â  Â  function selectEntry(row) {
Â  Â  Â  Â  clearSelection();
Â  Â  Â  Â  row.classList.add("selected");
Â  Â  Â  Â  document.getElementById("edit-btn").disabled = false;
Â  Â  Â  Â  document.getElementById("delete-btn").disabled = false;
Â  Â  Â  Â  selectedId = row.getAttribute("data-id");
Â  Â  }

Â  Â  function formatMoney(num) {
Â  Â  Â  Â  return (num || 0).toLocaleString("th-TH", { minimumFractionDigits: 2 });
Â  Â  }

Â  Â  function updateTotalPreview() {
Â  Â  Â  Â  const form = document.getElementById("add-form");
Â  Â  Â  Â  const income = parseFloat(form.income.value) || 0;
Â  Â  Â  Â  const expense = parseFloat(form.expense.value) || 0;
Â  Â  Â  Â  const creditCard = parseFloat(form.creditCard.value) || 0;
Â  Â  Â  Â  const cash = parseFloat(form.cash.value) || 0;

Â  Â  Â  Â  const netIncome = income - expense;
Â  Â  Â  Â  const total = creditCard + cash;

Â  Â  Â  Â  document.getElementById("netIncomePreview").value = formatMoney(netIncome);
Â  Â  Â  Â  document.getElementById("totalPreview").value = formatMoney(total);
Â  Â  }
Â  Â  
Â  Â  async function loadSales() {
Â  Â  Â  Â  clearSelection();
Â  Â  Â  Â  const salesTableBody = document.getElementById("sales-table-body");
Â  Â  Â  Â  salesTableBody.innerHTML = `<tr><td colspan="11" style="text-align:center;">â³ à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥...</td></tr>`;
Â  Â  Â  Â  updateSummary({});

Â  Â  Â  Â  const year = document.getElementById('year').value;
Â  Â  Â  Â  const startMonth = document.getElementById('startMonth').value;
Â  Â  Â  Â  const endMonth = document.getElementById('endMonth').value;

Â  Â  Â  Â  if (!year || !startMonth || !endMonth) {
Â  Â  Â  Â  Â  Â  salesTableBody.innerHTML = `<tr><td colspan="11" style="text-align:center;">à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸ à¸›à¸µ, à¹€à¸”à¸·à¸­à¸™à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ à¹à¸¥à¸°à¹€à¸”à¸·à¸­à¸™à¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”</td></tr>`;
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (parseInt(startMonth) > parseInt(endMonth)) {
Â  Â  Â  Â  Â  Â  salesTableBody.innerHTML = `<tr><td colspan="11" style="text-align:center;">à¹€à¸”à¸·à¸­à¸™à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸•à¹‰à¸­à¸‡à¸™à¹‰à¸­à¸¢à¸à¸§à¹ˆà¸²à¸«à¸£à¸·à¸­à¹€à¸—à¹ˆà¸²à¸à¸±à¸šà¹€à¸”à¸·à¸­à¸™à¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”</td></tr>`;
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  const startDate = `${year}-${String(startMonth).padStart(2, '0')}-01`;
Â  Â  Â  Â  const lastDay = new Date(year, endMonth, 0).getDate();
Â  Â  Â  Â  const endDate = `${year}-${String(endMonth).padStart(2, '0')}-${lastDay}`;

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(`${RENDER_BACKEND_URL}/api/sales?startDate=${startDate}&endDate=${endDate}`);
Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error('Failed to fetch sales data');
Â  Â  Â  Â  Â  Â  const salesData = await response.json();
Â  Â  Â  Â  Â  Â  currentSalesData = salesData;

Â  Â  Â  Â  Â  Â  if (salesData.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  salesTableBody.innerHTML = `<tr><td colspan="11" style="text-align:center;">à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥</td></tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let html = '';
Â  Â  Â  Â  Â  Â  let totalSummary = {
Â  Â  Â  Â  Â  Â  Â  Â  staffOil: 0, customers: 0, income: 0, commission: 0, 
Â  Â  Â  Â  Â  Â  Â  Â  extraCommission: 0, expense: 0, creditCard: 0, cash: 0, total: 0
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  salesData.forEach(sale => {
Â  Â  Â  Â  Â  Â  Â  Â  const date = new Date(sale.date._seconds * 1000); 
Â  Â  Â  Â  Â  Â  Â  Â  const dateStr = date.toLocaleDateString("th-TH");
Â  Â  Â  Â  Â  Â  Â  Â  const netIncome = (sale.income || 0) - (sale.expense || 0);
Â  Â  Â  Â  Â  Â  Â  Â  const totalIncome = (sale.creditCard || 0) + (sale.cash || 0);

Â  Â  Â  Â  Â  Â  Â  Â  totalSummary.staffOil += sale.staffOil || 0;
Â  Â  Â  Â  Â  Â  Â  Â  totalSummary.customers += sale.customers || 0;
Â  Â  Â  Â  Â  Â  Â  Â  totalSummary.income += sale.income || 0;
Â  Â  Â  Â  Â  Â  Â  Â  totalSummary.commission += sale.commission || 0;
Â  Â  Â  Â  Â  Â  Â  Â  totalSummary.extraCommission += sale.extraCommission || 0;
Â  Â  Â  Â  Â  Â  Â  Â  totalSummary.expense += sale.expense || 0;
Â  Â  Â  Â  Â  Â  Â  Â  totalSummary.creditCard += sale.creditCard || 0;
Â  Â  Â  Â  Â  Â  Â  Â  totalSummary.cash += sale.cash || 0;
Â  Â  Â  Â  Â  Â  Â  Â  totalSummary.total += totalIncome || 0;

Â  Â  Â  Â  Â  Â  Â  Â  html += `<tr onclick="selectEntry(this)" data-id="${sale._id}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${dateStr}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${formatMoney(sale.staffOil)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${sale.customers}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${formatMoney(sale.income)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${formatMoney(sale.commission)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${formatMoney(sale.extraCommission)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${formatMoney(sale.expense)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${formatMoney(sale.creditCard)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${formatMoney(sale.cash)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${formatMoney(netIncome)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${sale.timeWork || "-"}</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  salesTableBody.innerHTML = html;
Â  Â  Â  Â  Â  Â  updateSummary(totalSummary);
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error('Error fetching sales data:', error);
Â  Â  Â  Â  Â  Â  salesTableBody.innerHTML = `<tr><td colspan="11" style="text-align:center;">à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥: ${error.message}</td></tr>`;
Â  Â  Â  Â  }
Â  Â  }
Â  Â  
Â  Â  function updateSummary(totals) {
Â  Â  Â  Â  const netIncome = (totals.income || 0) - (totals.expense || 0);
Â  Â  Â  Â  document.getElementById('summary-customers').innerText = `${(totals.customers || 0)} à¸„à¸™`;
Â  Â  Â  Â  document.getElementById('summary-income').innerText = formatMoney(totals.income);
Â  Â  Â  Â  document.getElementById('summary-expense').innerText = formatMoney(totals.expense);
Â  Â  Â  Â  document.getElementById('summary-net-income').innerText = formatMoney(netIncome);
Â  Â  Â  Â  document.getElementById('summary-total').innerText = formatMoney((totals.creditCard || 0) + (totals.cash || 0));
Â  Â  }

Â  Â  async function deleteEntry() {
Â  Â  Â  Â  if (!selectedId) return;
Â  Â  Â  Â  if (confirm("à¸„à¸¸à¸“à¹à¸™à¹ˆà¹ƒà¸ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆà¸§à¹ˆà¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¥à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¸™à¸µà¹‰?")) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${RENDER_BACKEND_URL}/api/sales/${selectedId}`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'DELETE'
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error('Failed to delete entry');
Â  Â  Â  Â  Â  Â  Â  Â  loadSales();
Â  Â  Â  Â  Â  Â  Â  Â  clearSelection();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸¥à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥: " + error.message);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  document.getElementById("add-form").addEventListener("submit", async (e) => {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  const form = e.target;
Â  Â  Â  Â  const submitBtn = form.querySelector("button[type='submit']");
Â  Â  Â  Â  submitBtn.disabled = true;

Â  Â  Â  Â  const timeOpen = form.timeOpen.value;
Â  Â  Â  Â  const timeClose = form.timeClose.value;

Â  Â  Â  Â  const data = {
Â  Â  Â  Â  Â  Â  date: new Date(form.date.value),
Â  Â  Â  Â  Â  Â  staffOil: parseFloat(form.staffOil.value) || 0,
Â  Â  Â  Â  Â  Â  customers: parseInt(form.customers.value) || 0,
Â  Â  Â  Â  Â  Â  income: parseFloat(form.income.value) || 0,
Â  Â  Â  Â  Â  Â  commission: parseFloat(form.commission.value) || 0,
Â  Â  Â  Â  Â  Â  extraCommission: parseFloat(form.extraCommission.value) || 0,
Â  Â  Â  Â  Â  Â  expense: parseFloat(form.expense.value) || 0,
Â  Â  Â  Â  Â  Â  creditCard: parseFloat(form.creditCard.value) || 0,
Â  Â  Â  Â  Â  Â  cash: parseFloat(form.cash.value) || 0,
Â  Â  Â  Â  Â  Â  timeWork: `${timeOpen} - ${timeClose}`
Â  Â  Â  Â  };

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  let response;
Â  Â  Â  Â  Â  Â  const method = form.getAttribute("data-editing") === "true" && selectedId ? 'PUT' : 'POST';
Â  Â  Â  Â  Â  Â  const url = method === 'PUT' ? `${RENDER_BACKEND_URL}/api/sales/${selectedId}` : `${RENDER_BACKEND_URL}/api/sales`;

Â  Â  Â  Â  Â  Â  response = await fetch(url, {
Â  Â  Â  Â  Â  Â  Â  Â  method: method,
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(data)
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error('Failed to save data');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  closePopup();
Â  Â  Â  Â  Â  Â  loadSales();
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  alert("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥: " + error.message);
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  submitBtn.disabled = false;
Â  Â  Â  Â  Â  Â  form.removeAttribute("data-editing");
Â  Â  Â  Â  }
Â  Â  });
Â  Â  
Â  Â  document.getElementById("edit-btn").addEventListener("click", async () => {
Â  Â  Â  Â  if (!selectedId) return;

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(`${RENDER_BACKEND_URL}/api/sales/${selectedId}`);
Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error('Failed to fetch sale data');
Â  Â  Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  Â  Â  const form = document.getElementById("add-form");

Â  Â  Â  Â  Â  Â  const date = new Date(data.date._seconds * 1000);
Â  Â  Â  Â  Â  Â  form.date.value = date.toISOString().split("T")[0];
Â  Â  Â  Â  Â  Â  form.staffOil.value = data.staffOil || "";
Â  Â  Â  Â  Â  Â  form.customers.value = data.customers || "";
Â  Â  Â  Â  Â  Â  form.income.value = data.income || "";
Â  Â  Â  Â  Â  Â  form.commission.value = data.commission || "";
Â  Â  Â  Â  Â  Â  form.extraCommission.value = data.extraCommission || "";
Â  Â  Â  Â  Â  Â  form.expense.value = data.expense || "";
Â  Â  Â  Â  Â  Â  form.creditCard.value = data.creditCard || "";
Â  Â  Â  Â  Â  Â  form.cash.value = data.cash || "";
Â  Â  Â  Â  Â  Â  if (data.timeWork) {
Â  Â  Â  Â  Â  Â  Â  Â  const [timeOpen, timeClose] = data.timeWork.split(' - ');
Â  Â  Â  Â  Â  Â  Â  Â  form.timeOpen.value = timeOpen || "";
Â  Â  Â  Â  Â  Â  Â  Â  form.timeClose.value = timeClose || "";
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  form.timeOpen.value = "";
Â  Â  Â  Â  Â  Â  Â  Â  form.timeClose.value = "";
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  form.setAttribute("data-editing", "true");
Â  Â  Â  Â  Â  Â  openPopup();
Â  Â  Â  Â  Â  Â  updateTotalPreview();
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  alert("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥: " + error.message);
Â  Â  Â  Â  }
Â  Â  });
Â  Â  
Â  Â  async function exportToPdf() {
Â  Â  Â  Â  const { jsPDF } = window.jspdf;
Â  Â  Â  Â  const doc = new jsPDF('l');
Â  Â  Â  Â  
Â  Â  Â  Â  const year = document.getElementById('year').value;
Â  Â  Â  Â  const startMonth = document.getElementById('startMonth').options[document.getElementById('startMonth').selectedIndex].text;
Â  Â  Â  Â  const endMonth = document.getElementById('endMonth').options[document.getElementById('endMonth').selectedIndex].text;
Â  Â  Â  Â  
Â  Â  Â  Â  if (currentSalesData.length === 0) {
Â  Â  Â  Â  Â  Â  alert("à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰ Export");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const tableHeaders = ["à¸§à¸±à¸™à¸—à¸µà¹ˆ", "Staff Oil", "à¸¥à¸¹à¸à¸„à¹‰à¸²", "à¸£à¸²à¸¢à¸£à¸±à¸š", "à¸„à¹ˆà¸²à¸¡à¸·à¸­", "à¸„à¹ˆà¸²à¸¡à¸·à¸­à¸à¸´à¹€à¸¨à¸©", "à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢", "à¸šà¸±à¸•à¸£à¹€à¸„à¸£à¸”à¸´à¸•", "à¹€à¸‡à¸´à¸™à¸ªà¸”", "à¸¢à¸­à¸”à¸ªà¸¸à¸—à¸˜à¸´", "à¹€à¸§à¸¥à¸²à¸—à¸³à¸‡à¸²à¸™"];
Â  Â  Â  Â  const tableData = currentSalesData.map(sale => {
Â  Â  Â  Â  Â  Â  const date = new Date(sale.date._seconds * 1000);
Â  Â  Â  Â  Â  Â  const netIncome = (sale.income || 0) - (sale.expense || 0);
Â  Â  Â  Â  Â  Â  return [
Â  Â  Â  Â  Â  Â  Â  Â  date.toLocaleDateString("th-TH"),
Â  Â  Â  Â  Â  Â  Â  Â  formatMoney(sale.staffOil),
Â  Â  Â  Â  Â  Â  Â  Â  sale.customers,
Â  Â  Â  Â  Â  Â  Â  Â  formatMoney(sale.income),
Â  Â  Â  Â  Â  Â  Â  Â  formatMoney(sale.commission),
Â  Â  Â  Â  Â  Â  Â  Â  formatMoney(sale.extraCommission),
Â  Â  Â  Â  Â  Â  Â  Â  formatMoney(sale.expense),
Â  Â  Â  Â  Â  Â  Â  Â  formatMoney(sale.creditCard),
Â  Â  Â  Â  Â  Â  Â  Â  formatMoney(sale.cash),
Â  Â  Â  Â  Â  Â  Â  Â  formatMoney(netIncome),
Â  Â  Â  Â  Â  Â  Â  Â  sale.timeWork || "-"
Â  Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  const totals = currentSalesData.reduce((acc, sale) => {
Â  Â  Â  Â  Â  Â  acc.income += sale.income || 0;
Â  Â  Â  Â  Â  Â  acc.expense += sale.expense || 0;
Â  Â  Â  Â  Â  Â  acc.creditCard += sale.creditCard || 0;
Â  Â  Â  Â  Â  Â  acc.cash += sale.cash || 0;
Â  Â  Â  Â  Â  Â  return acc;
Â  Â  Â  Â  }, { income: 0, expense: 0, creditCard: 0, cash: 0 });
Â  Â  Â  Â  
Â  Â  Â  Â  const totalIncomeTotal = (totals.creditCard || 0) + (totals.cash || 0);

Â  Â  Â  Â  tableData.push([
Â  Â  Â  Â  Â  Â  'à¸¢à¸­à¸”à¸£à¸§à¸¡',
Â  Â  Â  Â  Â  Â  '', '',
Â  Â  Â  Â  Â  Â  formatMoney(totals.income),
Â  Â  Â  Â  Â  Â  '', '',
Â  Â  Â  Â  Â  Â  formatMoney(totals.expense),
Â  Â  Â  Â  Â  Â  formatMoney(totals.creditCard),
Â  Â  Â  Â  Â  Â  formatMoney(totals.cash),
Â  Â  Â  Â  Â  Â  formatMoney(totals.income - totals.expense),
Â  Â  Â  Â  Â  Â  ''
Â  Â  Â  Â  ]);
Â  Â  Â  Â  
Â  Â  Â  Â  doc.text(`à¸£à¸²à¸¢à¸‡à¸²à¸™à¸¢à¸­à¸”à¸‚à¸²à¸¢à¸£à¸²à¸¢à¸§à¸±à¸™`, 15, 15);
Â  Â  Â  Â  doc.text(`à¸ˆà¸²à¸ ${startMonth} ${year} à¸–à¸¶à¸‡ ${endMonth} ${year}`, 15, 22);
Â  Â  Â  Â  doc.text(`à¸¢à¸­à¸”à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”: ${formatMoney(totalIncomeTotal)} à¸šà¸²à¸—`, 15, 29);

Â  Â  Â  Â  doc.autoTable({
Â  Â  Â  Â  Â  Â  startY: 35,
Â  Â  Â  Â  Â  Â  head: [tableHeaders],
Â  Â  Â  Â  Â  Â  body: tableData,
Â  Â  Â  Â  Â  Â  theme: 'grid'
Â  Â  Â  Â  });

Â  Â  Â  Â  doc.save(`à¸¢à¸­à¸”à¸‚à¸²à¸¢-${startMonth}-${endMonth}-${year}.pdf`);
Â  Â  }

Â  Â  async function exportToExcel() {
Â  Â  Â  Â  if (currentSalesData.length === 0) {
Â  Â  Â  Â  Â  Â  alert("à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰ Export");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  const wsData = [
Â  Â  Â  Â  Â  Â  ["à¸§à¸±à¸™à¸—à¸µà¹ˆ", "Staff Oil", "à¸¥à¸¹à¸à¸„à¹‰à¸²", "à¸£à¸²à¸¢à¸£à¸±à¸š", "à¸„à¹ˆà¸²à¸¡à¸·à¸­", "à¸„à¹ˆà¸²à¸¡à¸·à¸­à¸à¸´à¹€à¸¨à¸©", "à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢", "à¸šà¸±à¸•à¸£à¹€à¸„à¸£à¸”à¸´à¸•", "à¹€à¸‡à¸´à¸™à¸ªà¸”", "à¸¢à¸­à¸”à¸ªà¸¸à¸—à¸˜à¸´", "à¹€à¸§à¸¥à¸²à¸—à¸³à¸‡à¸²à¸™"]
Â  Â  Â  Â  ];
Â  Â  Â  Â  
Â  Â  Â  Â  let totals = {
Â  Â  Â  Â  Â  Â  staffOil: 0, customers: 0, income: 0, commission: 0, extraCommission: 0, 
Â  Â  Â  Â  Â  Â  expense: 0, creditCard: 0, cash: 0
Â  Â  Â  Â  };

Â  Â  Â  Â  currentSalesData.forEach(sale => {
Â  Â  Â  Â  Â  Â  const date = new Date(sale.date._seconds * 1000);
Â  Â  Â  Â  Â  Â  const netIncome = (sale.income || 0) - (sale.expense || 0);
Â  Â  Â  Â  Â  Â  wsData.push([
Â  Â  Â  Â  Â  Â  Â  Â  date.toLocaleDateString("th-TH"),
Â  Â  Â  Â  Â  Â  Â  Â  sale.staffOil || 0,
Â  Â  Â  Â  Â  Â  Â  Â  sale.customers || 0,
Â  Â  Â  Â  Â  Â  Â  Â  sale.income || 0,
Â  Â  Â  Â  Â  Â  Â  Â  sale.commission || 0,
Â  Â  Â  Â  Â  Â  Â  Â  sale.extraCommission || 0,
Â  Â  Â  Â  Â  Â  Â  Â  sale.expense || 0,
Â  Â  Â  Â  Â  Â  Â  Â  sale.creditCard || 0,
Â  Â  Â  Â  Â  Â  Â  Â  sale.cash || 0,
Â  Â  Â  Â  Â  Â  Â  Â  netIncome,
Â  Â  Â  Â  Â  Â  Â  Â  sale.timeWork || "-"
Â  Â  Â  Â  Â  Â  ]);
Â  Â  Â  Â  Â  Â  // Update totals
Â  Â  Â  Â  Â  Â  totals.staffOil += sale.staffOil || 0;
Â  Â  Â  Â  Â  Â  totals.customers += sale.customers || 0;
Â  Â  Â  Â  Â  Â  totals.income += sale.income || 0;
Â  Â  Â  Â  Â  Â  totals.commission += sale.commission || 0;
Â  Â  Â  Â  Â  Â  totals.extraCommission += sale.extraCommission || 0;
Â  Â  Â  Â  Â  Â  totals.expense += sale.expense || 0;
Â  Â  Â  Â  Â  Â  totals.creditCard += sale.creditCard || 0;
Â  Â  Â  Â  Â  Â  totals.cash += sale.cash || 0;
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  const totalIncomeTotal = (totals.creditCard || 0) + (totals.cash || 0);

Â  Â  Â  Â  wsData.push([]);
Â  Â  Â  Â  wsData.push([
Â  Â  Â  Â  Â  Â  'à¸¢à¸­à¸”à¸£à¸§à¸¡',
Â  Â  Â  Â  Â  Â  totals.staffOil,
Â  Â  Â  Â  Â  Â  totals.customers,
Â  Â  Â  Â  Â  Â  totals.income,
Â  Â  Â  Â  Â  Â  totals.commission,
Â  Â  Â  Â  Â  Â  totals.extraCommission,
Â  Â  Â  Â  Â  Â  totals.expense,
Â  Â  Â  Â  Â  Â  totals.creditCard,
Â  Â  Â  Â  Â  Â  totals.cash,
Â  Â  Â  Â  Â  Â  totals.income - totals.expense,
Â  Â  Â  Â  Â  Â  ''
Â  Â  Â  Â  ]);
Â  Â  Â  Â  wsData.push([]);
Â  Â  Â  Â  wsData.push(['à¸¢à¸­à¸”à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”', totalIncomeTotal]);

Â  Â  Â  Â  const ws = XLSX.utils.aoa_to_sheet(wsData);
Â  Â  Â  Â  const wb = XLSX.utils.book_new();
Â  Â  Â  Â  XLSX.utils.book_append_sheet(wb, ws, "à¸¢à¸­à¸”à¸‚à¸²à¸¢");
Â  Â  Â  Â  
Â  Â  Â  Â  const year = document.getElementById('year').value;
Â  Â  Â  Â  const startMonth = document.getElementById('startMonth').options[document.getElementById('startMonth').selectedIndex].text;
Â  Â  Â  Â  const endMonth = document.getElementById('endMonth').options[document.getElementById('endMonth').selectedIndex].text;
Â  Â  Â  Â  
Â  Â  Â  Â  XLSX.writeFile(wb, `à¸¢à¸­à¸”à¸‚à¸²à¸¢-${startMonth}-${endMonth}-${year}.xlsx`);
Â  Â  }

Â  Â  window.loadSales = loadSales;
Â  Â  window.selectEntry = selectEntry;
Â  Â  window.deleteEntry = deleteEntry;
Â  Â  window.openPopup = openPopup;
Â  Â  window.closePopup = closePopup;
Â  Â  window.updateTotalPreview = updateTotalPreview;
Â  Â  
Â  Â  const monthNames = ['à¸¡.à¸„.', 'à¸.à¸.', 'à¸¡à¸µ.à¸„.', 'à¹€à¸¡.à¸¢.', 'à¸.à¸„.', 'à¸¡à¸´.à¸¢.', 'à¸.à¸„.', 'à¸ª.à¸„.', 'à¸.à¸¢.', 'à¸•.à¸„.', 'à¸.à¸¢.', 'à¸˜.à¸„.'];
Â  Â  const startMonthSelect = document.getElementById('startMonth');
Â  Â  const endMonthSelect = document.getElementById('endMonth');
Â  Â  const yearInput = document.getElementById('year');
Â  Â  const loadButton = document.getElementById('load-data-btn');
Â  Â  
Â  Â  monthNames.forEach((name, index) => {
Â  Â  Â  Â  const option1 = new Option(name, index + 1);
Â  Â  Â  Â  const option2 = new Option(name, index + 1);
Â  Â  Â  Â  startMonthSelect.add(option1);
Â  Â  Â  Â  endMonthSelect.add(option2);
Â  Â  });
Â  Â  
Â  Â  loadButton.addEventListener('click', loadSales);
Â  Â  document.getElementById("export-excel").addEventListener("click", exportToExcel);
Â  Â  document.getElementById("export-pdf").addEventListener("click", exportToPdf);

Â  Â  window.onload = () => {
Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  startMonthSelect.value = now.getMonth() + 1;
Â  Â  Â  Â  endMonthSelect.value = now.getMonth() + 1;
Â  Â  Â  Â  yearInput.value = now.getFullYear();
Â  Â  Â  Â  const salesTableBody = document.getElementById("sales-table-body");
Â  Â  Â  Â  salesTableBody.innerHTML = `<tr><td colspan="11" style="text-align:center;">à¸à¸£à¸¸à¸“à¸²à¸à¸” "à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥" à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹à¸¢à¸­à¸”à¸‚à¸²à¸¢</td></tr>`;
Â  Â  Â  Â  updateSummary({});
Â  Â  };
</script>
</body>
</html>