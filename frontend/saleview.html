<!DOCTYPE html>
<html lang="th">
<head>
 <meta charset="UTF-8">
 <title>à¸£à¸°à¸šà¸šà¸šà¸±à¸™à¸—à¸¶à¸à¸¢à¸­à¸”à¸‚à¸²à¸¢</title>
 <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3588/3588658.png" type="image/png" />
 <link rel="stylesheet" href="style.css">
 <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet">
 
 <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
 <h1>ğŸ“Š à¸£à¸°à¸šà¸šà¸šà¸±à¸™à¸—à¸¶à¸à¸¢à¸­à¸”à¸‚à¸²à¸¢à¸£à¸²à¸¢à¸§à¸±à¸™</h1>
 <a href="index.html" class="back">â† à¸à¸¥à¸±à¸šà¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</a>
  <div class="toolbar">
  <button onclick="openPopup()">â• Add</button>
  <button id="edit-btn" disabled>âœï¸ Edit</button>
  <button id="delete-btn" disabled onclick="deleteEntry()">âŒ Cancel</button>
  <button id="export-pdf">à¸ªà¹ˆà¸‡à¸­à¸­à¸ PDF</button>
  <button id="export-excel">à¸ªà¹ˆà¸‡à¸­à¸­à¸ Excel</button>
 <button id="theme-toggle">ğŸŒ™</button></div>
<div>
  <label>à¸ˆà¸²à¸ <input type="date" id="startDate" onchange="loadSales()"></label>
  <label>à¸–à¸¶à¸‡ <input type="date" id="endDate" onchange="loadSales()"></label>
 </div>
  <div id="sales-list"></div>

  <div id="popup" class="popup hidden">
  <div class="popup-content">
  <h2>à¹€à¸à¸´à¹ˆà¸¡à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸­à¸”à¸‚à¸²à¸¢</h2>
  <form id="add-form">
   <label>ğŸ“… à¸§à¸±à¸™à¸—à¸µà¹ˆ <input type="date" name="date" required></label>
   <label>ğŸ§´ Staff Oil (à¸šà¸²à¸—) <input type="number" name="staffOil" step="0.01"></label>
   <label>ğŸ‘¥ Customers (à¸„à¸™) <input type="number" name="customers"></label>
   <label>ğŸ’° Total income (à¸šà¸²à¸—) <input type="number" name="income" step="0.01"></label>
   <label>ğŸ“ˆ Commission <input type="number" name="commission" step="0.01"></label>
   <label>ğŸ’¹ Extra Commission <input type="number" name="extraCommission" step="0.01"></label>
   <label>ğŸ’¸ Expense <input type="number" name="expense" step="0.01"></label>
   <label>ğŸ’³ Credit Card <input type="number" name="creditCard" step="0.01" oninput="updateTotalPreview()"></label>
   <label>ğŸ“Š Total Credit Card <input type="number" id="totalCreditPreview" disabled></label>
   <label>ğŸ’µ Cash <input type="number" name="cash" step="0.01" oninput="updateTotalPreview()"></label>
   <label>ğŸ“Š Total Cash <input type="number" id="totalCashPreview" disabled></label>
   <label>ğŸ•“ à¹€à¸§à¸¥à¸²à¹€à¸›à¸´à¸” <input type="time" name="timeOpen"></label>
  <label>ğŸ•• à¹€à¸§à¸¥à¸²à¸›à¸´à¸” <input type="time" name="timeClose"></label>


   <button type="submit">ğŸ’¾ à¸šà¸±à¸™à¸—à¸¶à¸</button>
   <button type="button" onclick="closePopup()">âŒ à¸¢à¸à¹€à¸¥à¸´à¸</button>
  </form>
  </div>
 </div>
 
<script>
    // ** URL Backend à¸—à¸µà¹ˆ Deploy à¸šà¸™ Render **
    const RENDER_BACKEND_URL = 'https://ub-backend.onrender.com';

    const themeToggle = document.getElementById('theme-toggle');
    const darkMode = localStorage.getItem('darkMode') === 'true';
    if (darkMode) document.documentElement.classList.add('dark');
    themeToggle.innerText = darkMode ? 'â˜€ï¸' : 'ğŸŒ™';
    themeToggle.onclick = () => {
        const isDark = document.documentElement.classList.toggle('dark');
        themeToggle.innerText = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
        localStorage.setItem('darkMode', isDark);
    };

    let selectedId = null;

    function openPopup() {
        document.getElementById("popup").classList.remove("hidden");
    }

    // à¹‚à¸«à¸¥à¸”à¸¢à¸­à¸”à¸‚à¸²à¸¢à¸•à¸²à¸¡à¸§à¸±à¸™à¸—à¸µà¹ˆ
    async function loadSales() {
        clearSelection();
        const listEl = document.getElementById("sales-list");
        listEl.innerHTML = "â³ à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...";

        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;
        if (!startDate || !endDate) {
            listEl.innerHTML = "<p>à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸Šà¹ˆà¸§à¸‡à¸§à¸±à¸™à¸—à¸µà¹ˆà¹ƒà¸«à¹‰à¸„à¸£à¸š</p>";
            return;
        }

        try {
            const response = await fetch(`${RENDER_BACKEND_URL}/api/sales?startDate=${startDate}&endDate=${endDate}`);
            if (!response.ok) throw new Error('Failed to fetch sales data');
            const salesData = await response.json();

            if (salesData.length === 0) {
                listEl.innerHTML = "<p>à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥</p>";
                return;
            }

            let html = `<table class="sales-table"><thead><tr>
                <th>ğŸ“… à¸§à¸±à¸™à¸—à¸µà¹ˆ</th><th>ğŸ§´ Staff Oil</th><th>ğŸ‘¥ Customers</th><th>ğŸ’° Income</th>
                <th>ğŸ“ˆ Commission</th><th>ğŸ’¹ Extra</th><th>ğŸ’¸ Expense</th><th>ğŸ’³ Credit</th>
                <th>ğŸ§® Total Credit</th><th>ğŸ’µ Cash</th><th>ğŸ§® Total Cash</th><th>â±ï¸ à¹€à¸§à¸¥à¸²</th>
            </tr></thead><tbody>`;

            let totalCredit = 0;
            let totalCash = 0;

            salesData.forEach(sale => {
                const dateStr = new Date(sale.date).toLocaleDateString("th-TH");
                totalCredit += sale.creditCard || 0;
                totalCash += sale.cash || 0;
                
                const timeWork = (sale.timeOpen && sale.timeClose) ? `${sale.timeOpen} - ${sale.timeClose}` : "-";

                html += `<tr onclick="selectEntry(this)" data-id="${sale._id}">
                    <td>${dateStr}</td>
                    <td>${formatMoney(sale.staffOil)}</td>
                    <td>${sale.customers}</td>
                    <td>${formatMoney(sale.income)}</td>
                    <td>${formatMoney(sale.commission)}</td>
                    <td>${formatMoney(sale.extraCommission)}</td>
                    <td>${formatMoney(sale.expense)}</td>
                    <td>${formatMoney(sale.creditCard)}</td>
                    <td><b>${formatMoney(totalCredit)}</b></td>
                    <td>${formatMoney(sale.cash)}</td>
                    <td><b>${formatMoney(totalCash)}</b></td>
                    <td>${timeWork}</td>
                </tr>`;
            });

            html += `</tbody></table>`;
            listEl.innerHTML = html;
        } catch (error) {
            console.error('Error fetching sales data:', error);
            listEl.innerHTML = `<p>à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥: ${error.message}</p>`;
        }
    }

    function formatMoney(num) {
        return (num || 0).toLocaleString("th-TH", { minimumFractionDigits: 2 });
    }

    function clearSelection() {
        document.getElementById("edit-btn").disabled = true;
        document.getElementById("delete-btn").disabled = true;
        selectedId = null;
    }

    function selectEntry(row) {
        document.querySelectorAll("tbody tr").forEach(tr => tr.classList.remove("selected"));
        row.classList.add("selected");
        document.getElementById("edit-btn").disabled = false;
        document.getElementById("delete-btn").disabled = false;
        selectedId = row.getAttribute("data-id");
    }

    function closePopup() {
        document.getElementById("popup").classList.add("hidden");
        const form = document.getElementById("add-form");
        form.reset();
        form.removeAttribute("data-editing");
    }

    async function deleteEntry() {
        if (!selectedId) return;
        if (confirm("à¸„à¸¸à¸“à¹à¸™à¹ˆà¹ƒà¸ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆà¸§à¹ˆà¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¥à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¸™à¸µà¹‰?")) {
            try {
                const response = await fetch(`${RENDER_BACKEND_URL}/api/sales/${selectedId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('Failed to delete entry');
                loadSales();
                clearSelection();
            } catch (error) {
                alert("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸¥à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥: " + error.message);
            }
        }
    }

    function updateTotalPreview() {
        const creditCard = parseFloat(document.querySelector("input[name='creditCard']").value) || 0;
        const cash = parseFloat(document.querySelector("input[name='cash']").value) || 0;

        document.getElementById("totalCreditPreview").value = creditCard.toLocaleString("th-TH", {minimumFractionDigits: 2});
        document.getElementById("totalCashPreview").value = cash.toLocaleString("th-TH", {minimumFractionDigits: 2});
    }

    document.getElementById("add-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const form = e.target;
        const submitBtn = form.querySelector("button[type='submit']");
        submitBtn.disabled = true;

        const timeOpen = form.timeOpen.value;
        const timeClose = form.timeClose.value;

        const data = {
            date: form.date.value,
            staffOil: parseFloat(form.staffOil.value) || 0,
            customers: parseInt(form.customers.value) || 0,
            income: parseFloat(form.income.value) || 0,
            commission: parseFloat(form.commission.value) || 0,
            extraCommission: parseFloat(form.extraCommission.value) || 0,
            expense: parseFloat(form.expense.value) || 0,
            creditCard: parseFloat(form.creditCard.value) || 0,
            cash: parseFloat(form.cash.value) || 0,
            timeOpen: timeOpen || "",
            timeClose: timeClose || ""
        };

        try {
            let response;
            if (form.getAttribute("data-editing") === "true" && selectedId) {
                response = await fetch(`${RENDER_BACKEND_URL}/api/sales/${selectedId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } else {
                response = await fetch(`${RENDER_BACKEND_URL}/api/sales`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }
            if (!response.ok) throw new Error('Failed to save data');
            
            closePopup();
            loadSales();
            clearSelection();
        } catch (error) {
            alert("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥: " + error.message);
        } finally {
            submitBtn.disabled = false;
            form.removeAttribute("data-editing");
        }
    });
    
    document.getElementById("edit-btn").addEventListener("click", async () => {
        if (!selectedId) return;

        try {
            const response = await fetch(`${RENDER_BACKEND_URL}/api/sales/${selectedId}`);
            if (!response.ok) throw new Error('Failed to fetch sale data');
            const data = await response.json();

            const form = document.getElementById("add-form");

            form.date.value = data.date.split("T")[0];
            form.staffOil.value = data.staffOil || "";
            form.customers.value = data.customers || "";
            form.income.value = data.income || "";
            form.commission.value = data.commission || "";
            form.extraCommission.value = data.extraCommission || "";
            form.expense.value = data.expense || "";
            form.creditCard.value = data.creditCard || "";
            form.cash.value = data.cash || "";
            form.timeOpen.value = data.timeOpen || "";
            form.timeClose.value = data.timeClose || "";

            form.setAttribute("data-editing", "true");
            openPopup();
        } catch (error) {
            alert("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥: " + error.message);
        }
    });
    
    // ** à¹€à¸à¸´à¹ˆà¸¡à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ Export PDF **
    async function exportToPdf() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l');
        
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;
        
        const tableHeaders = ["à¸§à¸±à¸™à¸—à¸µà¹ˆ", "Staff Oil", "Customers", "Income", "Commission", "Extra", "Expense", "Credit", "Cash", "à¹€à¸§à¸¥à¸²"];
        const tableData = [];
        
        const salesRows = document.querySelectorAll("#sales-list tbody tr");
        if (salesRows.length === 0) {
            alert("à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰ Export");
            return;
        }
        
        salesRows.forEach(row => {
            const rowData = [];
            row.querySelectorAll('td').forEach((cell, index) => {
                if (index < 8 || index > 9) { // à¸‚à¹‰à¸²à¸¡à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œ Total Credit à¹à¸¥à¸° Total Cash
                     rowData.push(cell.innerText);
                }
            });
            tableData.push(rowData);
        });

        doc.text(`à¸£à¸²à¸¢à¸‡à¸²à¸™à¸¢à¸­à¸”à¸‚à¸²à¸¢à¸£à¸²à¸¢à¸§à¸±à¸™`, 15, 15);
        doc.text(`à¸ˆà¸²à¸à¸§à¸±à¸™à¸—à¸µà¹ˆ ${startDate} à¸–à¸¶à¸‡ ${endDate}`, 15, 22);

        doc.autoTable({
            startY: 28,
            head: [tableHeaders],
            body: tableData,
            theme: 'grid',
            styles: { font: 'Kanit' }
        });

        doc.save(`à¸¢à¸­à¸”à¸‚à¸²à¸¢-${startDate}-${endDate}.pdf`);
    }

    // ** à¹€à¸à¸´à¹ˆà¸¡à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ Export Excel **
    async function exportToExcel() {
        const table = document.querySelector("#sales-list table");
        if (!table) {
            alert("à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰ Export");
            return;
        }
        
        const ws = XLSX.utils.table_to_sheet(table);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "à¸¢à¸­à¸”à¸‚à¸²à¸¢");
        
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;
        
        XLSX.writeFile(wb, `à¸¢à¸­à¸”à¸‚à¸²à¸¢-${startDate}-${endDate}.xlsx`);
    }

    window.loadSales = loadSales;
    window.selectEntry = selectEntry;
    window.deleteEntry = deleteEntry;
    window.openPopup = openPopup;
    window.closePopup = closePopup;
    window.updateTotalPreview = updateTotalPreview;
    
    document.getElementById("export-excel").addEventListener("click", exportToExcel);
    document.getElementById("export-pdf").addEventListener("click", exportToPdf);

    // à¹‚à¸«à¸¥à¸”à¸„à¸£à¸±à¹‰à¸‡à¹à¸£à¸
    window.onload = () => {
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);

        const toDateInputString = (date) => {
            const y = date.getFullYear();
            const m = (date.getMonth() + 1).toString().padStart(2, "0");
            const d = date.getDate().toString().padStart(2, "0");
            return `${y}-${m}-${d}`;
        };

        document.getElementById("startDate").value = toDateInputString(firstDay);
        document.getElementById("endDate").value = toDateInputString(lastDay);

        loadSales();
    };
</script>
</body>
</html>