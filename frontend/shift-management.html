<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“… à¸ˆà¸±à¸”à¸à¸°à¸‡à¸²à¸™ / Shift Scheduler</title>
   <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/1828/1828911.png" type="image/png" />
  <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;500;700&display=swap" rel="stylesheet" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <a href="index.html" class="back">â† à¸à¸¥à¸±à¸šà¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</a>
  <script>const user=JSON.parse(localStorage.getItem('user')); if(!user) location.href='login.html';</script>
  <header>
    <h1 data-i18n="title"></h1>
    <div><button id="lang-toggle">EN</button><button id="theme-toggle">ğŸŒ™</button></div>
  </header>

  <section id="controls">
    <label data-i18n="month"></label>
    <select id="month"></select>
    <label data-i18n="year"></label>
    <input type="number" id="year" min="2000" />
    <button id="export-excel" data-i18n="exportExcel"></button>
    <button id="export-pdf" data-i18n="exportPdf"></button>
    <button id="save-cloud" data-i18n="saveCloud"></button>
  </section>

  <section id="sidebar">
    <div id="offs"><h3 data-i18n="weeklyOff"></h3><div id="off-inputs"></div></div>
    <div id="special">
      <h3 data-i18n="publicHolidays"></h3>
      <input type="date" id="new-holiday-date" />
      <input type="text" id="new-holiday-name" placeholder="" />
      <button id="add-holiday" data-i18n="addHoliday"></button>
      <ul id="public-holiday-list"></ul>
    </div>
    <div id="legend">
      <h3 data-i18n="legend"></h3>
      <ul>
        <li><span class="shift-A">A</span> â€“ 10:30-18:00</li>
        <li><span class="shift-B">B</span> â€“ 18:00-02:00</li>
        <li><span class="shift-L">L</span> â€“ 11:00-19:00</li>
        <li><span class="shift-C">C</span> â€“ Over Time</li>
        <li><span class="shift-PD">PD</span> â€“ Public Holiday</li>
        <li><span class="shift-LA">LA</span> â€“ Leave</li>
        <li><span class="shift-S">S</span> â€“ Sick</li>
        <li><span class="shift-OFF">OFF</span> â€“ Off Day</li>
      </ul>
    </div>
  </section>

  <section id="export-area">
    <div id="page-wrapper">
      <div id="table-container"></div>
      <div id="summary-container"></div>
    </div>
  </section>

  <script>
    // ** à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ URL à¸•à¸£à¸‡à¸™à¸µà¹‰à¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™ URL à¸‚à¸­à¸‡ Backend à¸—à¸µà¹ˆà¸„à¸¸à¸“ Deploy à¸šà¸™ Render **
    const RENDER_BACKEND_URL = 'https://ub-backend.onrender.com';

    // Theme toggle
    const themeToggle = document.getElementById('theme-toggle');
    const darkMode = localStorage.getItem('darkMode') === 'true';
    if (darkMode) document.documentElement.classList.add('dark');
    themeToggle.innerText = darkMode ? 'â˜€ï¸' : 'ğŸŒ™';
    themeToggle.onclick = () => {
      const isDark = document.documentElement.classList.toggle('dark');
      themeToggle.innerText = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
      localStorage.setItem('darkMode', isDark);
    };

    // Constants & translations
    const defaultHolidays = [
      {date:'2025-01-01',th:'à¸§à¸±à¸™à¸‚à¸¶à¹‰à¸™à¸›à¸µà¹ƒà¸«à¸¡à¹ˆ',en:"New Year's Day"},
      {date:'2025-02-12',th:'à¸§à¸±à¸™à¸¡à¸²à¸†à¸šà¸¹à¸Šà¸²',en:'Makha Bucha'},
      {date:'2025-04-13',th:'à¸§à¸±à¸™à¸ªà¸‡à¸à¸£à¸²à¸™à¸•à¹Œ',en:'Songkran'},
      {date:'2025-05-01',th:'à¸§à¸±à¸™à¹à¸£à¸‡à¸‡à¸²à¸™',en:'Labour Day'},
      {date:'2025-07-28',th:'à¸§à¸±à¸™à¹€à¸‰à¸¥à¸´à¸¡à¸¯ à¸£à¸±à¸Šà¸à¸²à¸¥à¸—à¸µà¹ˆ10',en:'King Maha BD'},
      {date:'2025-08-12',th:'à¸§à¸±à¸™à¹à¸¡à¹ˆà¹à¸«à¹ˆà¸‡à¸Šà¸²à¸•à¸´',en:"Motherâ€™s Day"},
      {date:'2025-10-23',th:'à¸§à¸±à¸™à¸›à¸´à¸¢à¸¡à¸«à¸²à¸£à¸²à¸Š',en:'Chulalongkorn Day'},
      {date:'2025-12-05',th:'à¸§à¸±à¸™à¸à¹ˆà¸­à¹à¸«à¹ˆà¸‡à¸Šà¸²à¸•à¸´',en:"Fatherâ€™s Day"},
      {date:'2025-12-31',th:'à¸§à¸±à¸™à¸ªà¸´à¹‰à¸™à¸›à¸µ',en:'New Year Eve'}
    ];
    let holidays = [...defaultHolidays];
    const translations = {
      th: {title:'ğŸ“… à¸ˆà¸±à¸”à¸à¸²à¸£à¸•à¸²à¸£à¸²à¸‡à¸‡à¸²à¸™',month:'à¹€à¸”à¸·à¸­à¸™',year:'à¸›à¸µ',exportExcel:'à¸ªà¹ˆà¸‡à¸­à¸­à¸ Excel',exportPdf:'à¸ªà¹ˆà¸‡à¸­à¸­à¸ PDF',saveCloud:'à¸šà¸±à¸™à¸—à¸¶à¸ Cloud',saving:'à¸à¸³à¸¥à¸±à¸‡à¸šà¸±à¸™à¸—à¸¶à¸...',saveSuccess:'à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ',saveFail:'à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ',weeklyOff:'à¸§à¸±à¸™à¸«à¸¢à¸¸à¸”à¸›à¸£à¸°à¸ˆà¸³à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ',publicHolidays:'à¸§à¸±à¸™à¸«à¸¢à¸¸à¸”à¸à¸´à¹€à¸¨à¸©',addHoliday:'à¹€à¸à¸´à¹ˆà¸¡à¸§à¸±à¸™à¸«à¸¢à¸¸à¸”',legend:'à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢',employee:'à¸à¸™à¸±à¸à¸‡à¸²à¸™'},
      en: {title:'ğŸ“… Shift Scheduler',month:'Month',year:'Year',exportExcel:'Export Excel',exportPdf:'Export PDF',saveCloud:'Save Cloud',saving:'Saving...',saveSuccess:'Saved successfully',saveFail:'Save failed',weeklyOff:'Weekly Off',publicHolidays:'Public Holidays',addHoliday:'Add Holiday',legend:'Legend',employee:'Employee'}
    };
    let lang='th';
    const daysOfWeek=[
		{val:0,th:'à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œ',en:'Sun'},
		{val:1,th:'à¸ˆà¸±à¸™à¸—à¸£à¹Œ',en:'Mon'},
		{val:2,th:'à¸­à¸±à¸‡à¸„à¸²à¸£',en:'Tue'},
		{val:3,th:'à¸à¸¸à¸˜',en:'Wed'},
		{val:4,th:'à¸à¸¤à¸«à¸±à¸ªà¸šà¸”à¸µ',en:'Thu'},
		{val:5,th:'à¸¨à¸¸à¸à¸£à¹Œ',en:'Fri'},
		{val:6,th:'à¹€à¸ªà¸²à¸£à¹Œ',en:'Sat'}];
    let employees = [];
    let shifts = [];
    const weeklyOff = {};
    let currentSchedule = []; // à¸•à¸±à¸§à¹à¸›à¸£à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸à¹‡à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸•à¸²à¸£à¸²à¸‡à¸à¸°à¸‡à¸²à¸™

    // Helpers
    const monthSelect = document.getElementById('month'),
          yearInput   = document.getElementById('year'),
          pageWrapper = document.getElementById('page-wrapper'),
          tableContainer   = document.getElementById('table-container'),
          summaryContainer = document.getElementById('summary-container'),
          newHolidayDate   = document.getElementById('new-holiday-date'),
          newHolidayName   = document.getElementById('new-holiday-name'),
          addHolidayBtn    = document.getElementById('add-holiday'),
          publicHolidayList= document.getElementById('public-holiday-list'),
          offInputs        = document.getElementById('off-inputs');

    function currentMY(){ return { month:+monthSelect.value, year:+yearInput.value }; }
    function colorShift(td,val){ td.className=td.className.replace(/\bshift-\w+/g,''); if(val) td.classList.add(`shift-${val}`); }
    
function aoa(sel) {
  return Array.from(document.querySelector(sel).rows).map(r =>
    Array.from(r.cells).map(c => {
      const s = c.querySelector('select');
      if (s) return s.value || '';
      return c.textContent.trim();
    })
  );
}

function prepareForBackend(sel) {
  const rows = aoa(sel);
  return rows.map((row, rowIndex) => {
    return row.reduce((o, v, colIndex) => {
      o[`c${colIndex}`] = v || '';
      return o;
    }, {});
  });
}

    // Rendering
    function initControls(){
      for(let i=1;i<=12;i++) monthSelect.appendChild(new Option(i,i));
      monthSelect.value=new Date().getMonth()+1;
      yearInput.value=new Date().getFullYear();
      monthSelect.onchange=loadFullData; yearInput.onchange=loadFullData;
      document.getElementById('export-excel').onclick=exportExcel;
      document.getElementById('export-pdf').onclick=exportPDF;
      document.getElementById('save-cloud').onclick=saveScheduleToBackend;
      document.getElementById('lang-toggle').onclick=()=>{
        lang=lang==='th'?'en':'th';
        document.getElementById('lang-toggle').innerText=lang==='th'?'EN':'à¹„à¸—à¸¢';
        setTexts(); redrawAll(); initOffInputs();
      };
    }
    function setTexts(){ document.querySelectorAll('[data-i18n]').forEach(el=>el.innerText=translations[lang][el.dataset.i18n]);
      newHolidayName.placeholder=lang==='th'?'à¸Šà¸·à¹ˆà¸­à¸§à¸±à¸™à¸«à¸¢à¸¸à¸”':'Holiday name';
      addHolidayBtn.innerText=translations[lang].addHoliday;
    }
    function bindHolidayControls(){ addHolidayBtn.onclick=()=>{ const d=newHolidayDate.value,n=newHolidayName.value.trim(); if(!d||!n)return; holidays.push({date:d,th:n,en:n}); newHolidayDate.value=newHolidayName.value=''; redrawAll(); }; }
    function renderHolidayList(){ publicHolidayList.innerHTML=''; const {month,year}=currentMY(); holidays.filter(h=>h.date.startsWith(`${year}-${String(month).padStart(2,'0')}`)).sort((a,b)=>a.date.localeCompare(b.date)).forEach(h=>{ const li=document.createElement('li'); li.className='holiday-item'; li.innerHTML=`<span>${h.date.slice(-2)}/${h.date.slice(5,7)} â€“ ${lang==='th'?h.th:h.en}</span>`; const del=document.createElement('button'); del.className='delete-btn'; del.textContent='âœ•'; del.onclick=()=>{holidays=holidays.filter(x=>x!==h); redrawAll();}; li.appendChild(del); publicHolidayList.appendChild(li); }); }
    function initOffInputs(){ offInputs.innerHTML=''; employees.forEach(e=>{ const div=document.createElement('div'); div.innerHTML=`${e}: `; const sel=document.createElement('select'); daysOfWeek.forEach(dw=>sel.appendChild(new Option(lang==='th'?dw.th:dw.en,dw.val))); sel.value=weeklyOff[e]||''; sel.onchange=()=>{ weeklyOff[e]=sel.value===''?null:+sel.value; redrawAll(); }; div.appendChild(sel); offInputs.appendChild(div); }); }
    
    function buildSchedule(){ 
      const {month,year}=currentMY(); 
      const days=new Date(year,month,0).getDate(); 
      const tbl=document.createElement('table'); 
      const thead=tbl.createTHead(), row=thead.insertRow(); 
      row.appendChild(document.createElement('th')).innerText=translations[lang].employee; 
      for(let d=1;d<=days;d++){ 
        const dow=new Date(year,month-1,d).getDay(); 
        const th=document.createElement('th'); 
        th.innerText=`${d}\n${lang==='th'?daysOfWeek[dow].th:daysOfWeek[dow].en}`; 
        row.appendChild(th);
      } 
      const tbody=tbl.appendChild(document.createElement('tbody')); 
      const holTr=tbody.insertRow(); 
      holTr.appendChild(document.createElement('td')).innerText=translations[lang].publicHolidays; 
      for(let d=1;d<=days;d++){ 
        const td=holTr.insertCell(); 
        const iso=`${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`; 
        if(holidays.find(h=>h.date===iso)){td.innerText='PD';td.classList.add('shift-PD');}
      } 
      employees.forEach(emp=>{ 
        const tr=tbody.insertRow(); 
        tr.appendChild(document.createElement('td')).innerText=emp;
        const employeeSchedule = currentSchedule.find(s => s.c0 === emp) || {};
        for(let d=1;d<=days;d++){ 
          const td=tr.insertCell(); 
          const sel=document.createElement('select'); 
          shifts.forEach(s=>sel.appendChild(new Option(s,s)));
          
          // Set initial value from loaded schedule
          const savedShift = employeeSchedule[`c${d}`];
          if (shifts.includes(savedShift)) {
            sel.value = savedShift;
          }
          
          sel.onchange = () => {
            colorShift(td, sel.value);
            updateSummary();
          };
          colorShift(td, sel.value); // Initial color
          td.appendChild(sel); 
          const date=new Date(year,month-1,d); 
          if(weeklyOff[emp]!=null&&date.getDay()===weeklyOff[emp]){ 
            sel.value='OFF';
            colorShift(td,'OFF');
          }
        }
      }); 
      return tbl; 
    }

    function updateSummary(){ 
      summaryContainer.innerHTML=''; 
      summaryContainer.appendChild(buildSummary()); 
    }

    function buildSummary(){ 
      const tbl=document.createElement('table'); 
      const summaryThead=tbl.createTHead(), summaryHeadRow=summaryThead.insertRow(); 
      summaryHeadRow.insertCell().innerText = translations[lang].employee;

      shifts.filter(s => s).forEach(s => {
        const th = summaryHeadRow.insertCell();
        th.innerText = s;
      });

      const summaryTbody = tbl.createTBody();
      employees.forEach(name => {
        const tr = summaryTbody.insertRow();
        tr.insertCell().innerText = name;

        const counts = Object.fromEntries(shifts.map(s => [s, 0]));
        const rowObj = currentSchedule.find(r => r.c0 === name) || {};
        for (let d = 1; d <= new Date(currentMY().year, currentMY().month, 0).getDate(); d++) {
          const val = rowObj[`c${d}`] || '';
          if (shifts.includes(val)) counts[val]++;
        }
        shifts.filter(s => s).forEach(s => {
          const td = tr.insertCell();
          td.innerText = counts[s];
        });
      });
      return tbl;
    }

    function redrawAll(){ 
      setTexts(); 
      renderHolidayList(); 
      tableContainer.innerHTML=''; 
      tableContainer.appendChild(buildSchedule()); 
      updateSummary(); 
    }

    // EXPORT
    function exportExcel(){ const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(aoa('#table-container table')),'Schedule'); XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(aoa('#summary-container table')),'Summary'); XLSX.writeFile(wb,'schedule.xlsx'); }
    function exportPDF(){ html2canvas(pageWrapper,{scale:2}).then(canvas=>{ const{jsPDF}=window.jspdf; const pdf=new jsPDF({orientation:'landscape',unit:'pt',format:'a4'}); const pw=pdf.internal.pageSize.getWidth(); const ih=(canvas.height*pw)/canvas.width; let pos=0,left=ih-pdf.internal.pageSize.getHeight(); const img=canvas.toDataURL('image/png'); pdf.addImage(img,'PNG',0,pos,pw,ih); while(left>0){ pos-=pdf.internal.pageSize.getHeight(); pdf.addImage(img,'PNG',0,pos,pw,ih); left-=pdf.internal.pageSize.getHeight(); } pdf.save('schedule.pdf'); }); }

    // SAVE to Backend
    async function saveScheduleToBackend(){ 
      const btn=document.getElementById('save-cloud'); 
      btn.disabled=true; 
      const txt=btn.innerText; 
      btn.innerText=translations[lang].saving; 
      const{month,year}=currentMY(); 
      
      const payload={
        month,
        year,
        schedule: prepareForBackend('#table-container table tbody'),
        summary: prepareForBackend('#summary-container table tbody')
      };

      try {
        const response = await fetch(`${RENDER_BACKEND_URL}/api/schedules`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if(!response.ok) throw new Error(response.statusText);
        btn.innerText=translations[lang].saveSuccess;
      } catch (e) {
        console.error('Error saving schedule:', e);
        btn.innerText=translations[lang].saveFail;
      } finally {
        btn.disabled=false;
        setTimeout(()=>btn.innerText=txt,2000); 
      }
    }

    // LOAD from Backend
    async function loadFullData() {
      const { month, year } = currentMY();
      // à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸™à¸±à¸à¸‡à¸²à¸™à¹à¸¥à¸°à¸à¸°à¸‡à¸²à¸™
      try {
        const [employeesRes, shiftsRes] = await Promise.all([
          fetch(`${RENDER_BACKEND_URL}/api/employees`),
          fetch(`${RENDER_BACKEND_URL}/api/shifts`)
        ]);
        employees = (await employeesRes.json()).map(e => e.Name);
        const shiftData = await shiftsRes.json();
        shifts = ['', ...shiftData.map(s => s.name)];
      } catch (e) {
        console.error('âŒ à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§', e);
        // à¹ƒà¸Šà¹‰à¸„à¹ˆà¸² default à¸«à¸²à¸à¹‚à¸«à¸¥à¸”à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ
        employees = ["K.Nu", "K.Ning", "K.Som"];
        shifts = ['','A','B','L','C','PD','S','LA','OFF'];
      }

      // à¹‚à¸«à¸¥à¸”à¸•à¸²à¸£à¸²à¸‡à¸à¸°à¸‡à¸²à¸™
      try {
        const response = await fetch(`${RENDER_BACKEND_URL}/api/schedules/${year}/${month}`);
        if (response.ok) {
          const doc = await response.json();
          currentSchedule = doc.schedule;
        } else {
          // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥ (404) à¹ƒà¸«à¹‰à¸–à¸·à¸­à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸•à¸²à¸£à¸²à¸‡à¸§à¹ˆà¸²à¸‡
          if (response.status === 404) {
            currentSchedule = [];
          } else {
            throw new Error(response.statusText);
          }
        }
      } catch (e) {
        console.error('âŒ à¹‚à¸«à¸¥à¸”à¸•à¸²à¸£à¸²à¸‡à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§', e);
        currentSchedule = [];
      }

      // à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹à¸¥à¹‰à¸§à¸ˆà¸¶à¸‡à¸§à¸²à¸”à¸«à¸™à¹‰à¸²à¸ˆà¸­à¹ƒà¸«à¸¡à¹ˆ
      initOffInputs();
      redrawAll();
    }


window.onload = async () => {
  initControls();
  bindHolidayControls();
  setTexts();
  await loadFullData();
};
  </script>
</body>
</html>