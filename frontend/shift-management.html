<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üìÖ ‡∏à‡∏±‡∏î‡∏Å‡∏∞‡∏á‡∏≤‡∏ô / Shift Scheduler</title>
   <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/1828/1828911.png" type="image/png" />
  <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;500;700&display=swap" rel="stylesheet" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body>
  <a href="index.html" class="back">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
  <script>const user=JSON.parse(localStorage.getItem('user')); if(!user) location.href='login.html';</script>
  <header>
    <h1 data-i18n="title"></h1>
    <div><button id="lang-toggle">EN</button><button id="theme-toggle">üåô</button></div>
  </header>

  <section id="controls">
    <label data-i18n="month"></label>
    <select id="month"></select>
    <label data-i18n="year"></label>
    <input type="number" id="year" min="2000" />
    <button id="export-excel" data-i18n="exportExcel"></button>
    <button id="export-pdf" data-i18n="exportPdf"></button>
    <button id="save-cloud" data-i18n="saveCloud"></button>
  </section>

  <section id="sidebar">
    <div id="offs"><h3 data-i18n="weeklyOff"></h3><div id="off-inputs"></div></div>
    <div id="special">
      <h3 data-i18n="publicHolidays"></h3>
      <input type="date" id="new-holiday-date" />
      <input type="text" id="new-holiday-name" placeholder="" />
      <button id="add-holiday" data-i18n="addHoliday"></button>
      <ul id="public-holiday-list"></ul>
    </div>
    <div id="legend">
      <h3 data-i18n="legend"></h3>
      <ul>
        <li><span class="shift-A">A</span>   10:30-18:00</li>
        <li><span class="shift-B">B</span>   18:00-02:00</li>
        <li><span class="shift-L">L</span>   11:00-19:00</li>
        <li><span class="shift-C">C</span>   Over Time</li>
        <li><span class="shift-PD">PD</span>   Public Holiday</li>
        <li><span class="shift-LA">LA</span>   Leave</li>
        <li><span class="shift-S">S</span>   Sick</li>
        <li><span class="shift-OFF">OFF</span>   Off Day</li>
      </ul>
    </div>
  </section>

  <section id="export-area">
    <div id="page-wrapper">
      <div id="table-container"></div>
      <div id="summary-container"></div>
    </div>
  </section>

  <script>
    // ** ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á Backend ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì Deploy ‡∏ö‡∏ô Render **
    const RENDER_BACKEND_URL = 'https://ub-backend.onrender.com';

    // Theme toggle
    const themeToggle = document.getElementById('theme-toggle');
    const darkMode = localStorage.getItem('darkMode') === 'true';
    if (darkMode) document.documentElement.classList.add('dark');
    themeToggle.innerText = darkMode ? '‚òÄÔ∏è' : 'üåô';
    themeToggle.onclick = () => {
      const isDark = document.documentElement.classList.toggle('dark');
      themeToggle.innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
      localStorage.setItem('darkMode', isDark);
    };

    // Constants & translations
    let holidays = [];
    const defaultHolidays = [
      {date:'2025-01-01',th:'‡∏ß‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà',en:"New Year's Day"},
      {date:'2025-02-12',th:'‡∏ß‡∏±‡∏ô‡∏°‡∏≤‡∏Ü‡∏ö‡∏π‡∏ä‡∏≤',en:'Makha Bucha'},
      {date:'2025-04-13',th:'‡∏ß‡∏±‡∏ô‡∏™‡∏á‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå',en:'Songkran'},
      {date:'2025-05-01',th:'‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô',en:'Labour Day'},
      {date:'2025-07-28',th:'‡∏ß‡∏±‡∏ô‡πÄ‡∏â‡∏•‡∏¥‡∏°‡∏Ø ‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà10',en:'King Maha BD'},
      {date:'2025-08-12',th:'‡∏ß‡∏±‡∏ô‡πÅ‡∏°‡πà‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥',en:"Mother‚Äôs Day"},
      {date:'2025-10-23',th:'‡∏ß‡∏±‡∏ô‡∏õ‡∏¥‡∏¢‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä',en:'Chulalongkorn Day'},
      {date:'2025-12-05',th:'‡∏ß‡∏±‡∏ô‡∏û‡πà‡∏≠‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥',en:"Father‚Äôs Day"},
      {date:'2025-12-31',th:'‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏õ‡∏µ',en:'New Year Eve'}
    ];
    const translations = {
      th: {title:'üìÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô',month:'‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',year:'‡∏õ‡∏µ',exportExcel:'‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel',exportPdf:'‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF',saveCloud:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Cloud',saving:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...',saveSuccess:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',saveFail:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',weeklyOff:'‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',publicHolidays:'‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©',addHoliday:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î',legend:'‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢',employee:'‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'},
      en: {title:'üìÖ Shift Scheduler',month:'Month',year:'Year',exportExcel:'Export Excel',exportPdf:'Export PDF',saveCloud:'Save Cloud',saving:'Saving...',saveSuccess:'Saved successfully',saveFail:'Save failed',weeklyOff:'Weekly Off',publicHolidays:'Public Holidays',addHoliday:'Add Holiday',legend:'Legend',employee:'Employee'}
    };
    let lang='th';
    const daysOfWeek=[
    {val:0,th:'‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå',en:'Sun'},
    {val:1,th:'‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå',en:'Mon'},
    {val:2,th:'‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£',en:'Tue'},
    {val:3,th:'‡∏û‡∏∏‡∏ò',en:'Wed'},
    {val:4,th:'‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ',en:'Thu'},
    {val:5,th:'‡∏®‡∏∏‡∏Å‡∏£‡πå',en:'Fri'},
    {val:6,th:'‡πÄ‡∏™‡∏≤‡∏£‡πå',en:'Sat'}];
    let employees = [];
    const shifts=['','A','B','L','C','PD','S','LA','OFF'];
    const weeklyOff={};

    // Helpers
    const monthSelect = document.getElementById('month'),
          yearInput   = document.getElementById('year'),
          pageWrapper = document.getElementById('page-wrapper'),
          tableContainer   = document.getElementById('table-container'),
          summaryContainer = document.getElementById('summary-container'),
          newHolidayDate   = document.getElementById('new-holiday-date'),
          newHolidayName   = document.getElementById('new-holiday-name'),
          addHolidayBtn    = document.getElementById('add-holiday'),
          publicHolidayList= document.getElementById('public-holiday-list'),
          offInputs        = document.getElementById('off-inputs');

    function currentMY(){ return { month:+monthSelect.value, year:+yearInput.value }; }
    function colorShift(td,val){ td.className=td.className.replace(/\bshift-\w+/g,''); if(val) td.classList.add(`shift-${val}`); }
    
    function aoa(sel) {
      return Array.from(document.querySelector(sel).rows).map(r =>
        Array.from(r.cells).map(c => {
          const s = c.querySelector('select');
          if (s) return s.value || '';
          return c.textContent.trim();
        })
      );
    }

    function prepareForFirestore(sel) {
      const rows = aoa(sel);
      return rows.map((row, rowIndex) => {
        return row.reduce((o, v, colIndex) => {
          o[`c${colIndex}`] = v || '';
          return o;
        }, {});
      });
    }

    // Rendering
    function initControls(){
      for(let i=1;i<=12;i++) monthSelect.appendChild(new Option(i,i));
      monthSelect.value=new Date().getMonth()+1;
      yearInput.value=new Date().getFullYear();
      monthSelect.onchange=redrawAll; yearInput.onchange=redrawAll;
      document.getElementById('export-excel').onclick=exportExcel;
      document.getElementById('export-pdf').onclick=exportPDF;
      document.getElementById('save-cloud').onclick=saveScheduleToMongoDB;
      document.getElementById('lang-toggle').onclick=()=>{
        lang=lang==='th'?'en':'th';
        document.getElementById('lang-toggle').innerText=lang==='th'?'EN':'‡πÑ‡∏ó‡∏¢';
        setTexts(); redrawAll(); initOffInputs();
      };
    }
    function setTexts(){ document.querySelectorAll('[data-i18n]').forEach(el=>el.innerText=translations[lang][el.dataset.i18n]);
      newHolidayName.placeholder=lang==='th'?'‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î':'Holiday name';
      addHolidayBtn.innerText=translations[lang].addHoliday;
    }
    function bindHolidayControls(){ addHolidayBtn.onclick=()=>{ const d=newHolidayDate.value,n=newHolidayName.value.trim(); if(!d||!n)return; holidays.push({date:d,th:n,en:n}); newHolidayDate.value=newHolidayName.value=''; redrawAll(); }; }
    function renderHolidayList(){ publicHolidayList.innerHTML=''; const {month,year}=currentMY(); holidays.filter(h=>h.date.startsWith(`${year}-${String(month).padStart(2,'0')}`)).sort((a,b)=>a.date.localeCompare(b.date)).forEach(h=>{ const li=document.createElement('li'); li.className='holiday-item'; li.innerHTML=`<span>${h.date.slice(-2)}/${h.date.slice(5,7)}   ${lang==='th'?h.th:h.en}</span>`; const del=document.createElement('button'); del.className='delete-btn'; del.textContent='‚úï'; del.onclick=()=>{holidays=holidays.filter(x=>x!==h); redrawAll();}; li.appendChild(del); publicHolidayList.appendChild(li); }); }
    function initOffInputs(){ offInputs.innerHTML=''; employees.forEach(e=>{ const div=document.createElement('div'); div.innerHTML=`${e}: `; const sel=document.createElement('select'); daysOfWeek.forEach(dw=>sel.appendChild(new Option(lang==='th'?dw.th:dw.en,dw.val))); sel.value=weeklyOff[e]||''; sel.onchange=()=>{ weeklyOff[e]=sel.value===''?null:+sel.value; redrawAll(); }; div.appendChild(sel); offInputs.appendChild(div); }); }
    function buildSchedule(){ const {month,year}=currentMY(); const days=new Date(year,month,0).getDate(); const tbl=document.createElement('table'); const thead=tbl.createTHead(), row=thead.insertRow(); row.appendChild(document.createElement('th')).innerText=translations[lang].employee; for(let d=1;d<=days;d++){ const dow=new Date(year,month-1,d).getDay(); const th=document.createElement('th'); th.innerText=`${d}\n${lang==='th'?daysOfWeek[dow].th:daysOfWeek[dow].en}`; row.appendChild(th);} const tbody=tbl.appendChild(document.createElement('tbody')); const holTr=tbody.insertRow(); holTr.appendChild(document.createElement('td')).innerText=translations[lang].publicHolidays; for(let d=1;d<=days;d++){ const td=holTr.insertCell(); const iso=`${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`; if(holidays.find(h=>h.date===iso)){td.innerText='PD';td.classList.add('shift-PD');}} employees.forEach(emp=>{ const tr=tbody.insertRow(); const td=document.createElement('td');
        td.innerText=emp;
        
        
        td.addEventListener('drop',()=> {
          
        });
        tr.appendChild(td); for(let d=1;d<=days;d++){ const td=tr.insertCell(); const sel=document.createElement('select'); shifts.forEach(s=>sel.appendChild(new Option(s,s))); sel.oninput=()=>{colorShift(td,sel.value);      updateSummary();
      const btn = document.getElementById('save-cloud');
      btn.innerText = '‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß';
      setTimeout(() => btn.innerText = translations[lang].saveCloud, 2000);
}; td.appendChild(sel); const date=new Date(year,month-1,d); if(weeklyOff[emp]!=null&&date.getDay()===weeklyOff[emp]){ sel.value='OFF';colorShift(td,'OFF');}}}); return tbl; }
    function updateSummary(){ summaryContainer.innerHTML=''; summaryContainer.appendChild(buildSummary()); }
    function buildSummary(){ const tbl=document.createElement('table'); const thead=tbl.createTHead(), row=thead.insertRow(); row.appendChild(document.createElement('th')).innerText=translations[lang].employee; shifts.filter(s=>s).forEach(s=>row.appendChild(document.createElement('th')).innerText=s); const tbody=tbl.appendChild(document.createElement('tbody')); employees.forEach(emp=>{ const tr=tbody.insertRow(); const td=document.createElement('td');
        td.innerText=emp;
        
        
        td.addEventListener('drop',()=> {
          
        });
        tr.appendChild(td); const counts=Object.fromEntries(shifts.map(s=>[s,0])); document.querySelectorAll('#table-container tbody tr').forEach(r=>{ if(r.firstChild.innerText===emp) r.querySelectorAll('td select').forEach(sel=>counts[sel.value]++); }); shifts.filter(s=>s).forEach(s=>tr.appendChild(document.createElement('td')).innerText=counts[s]); }); return tbl; }
    function redrawAll(){ setTexts(); renderHolidayList(); tableContainer.innerHTML=''; tableContainer.appendChild(buildSchedule()); updateSummary(); }

    // EXPORT
    function exportExcel(){ const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(aoa('#table-container table')),'Schedule'); XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(aoa('#summary-container table')),'Summary'); XLSX.writeFile(wb,'schedule.xlsx'); }
    function exportPDF(){ html2canvas(pageWrapper,{scale:2}).then(canvas=>{ const{jsPDF}=window.jspdf; const pdf=new jsPDF({orientation:'landscape',unit:'pt',format:'a4'}); const pw=pdf.internal.pageSize.getWidth(); const ih=(canvas.height*pw)/canvas.width; let pos=0,left=ih-pdf.internal.pageSize.getHeight(); const img=canvas.toDataURL('image/png'); pdf.addImage(img,'PNG',0,pos,pw,ih); while(left>0){ pos-=pdf.internal.pageSize.getHeight(); pdf.addImage(img,'PNG',0,pos,pw,ih); left-=pdf.internal.pageSize.getHeight(); } pdf.save('schedule.pdf'); }); }

    // SAVE to MongoDB (manual)
    async function saveScheduleToMongoDB(){ 
      const btn=document.getElementById('save-cloud'); 
      btn.disabled=true; 
      const txt=btn.innerText; 
      btn.innerText=translations[lang].saving; 
      const{month,year}=currentMY(); 
      const payload={
        month,
        year,
        schedule:prepareForFirestore('#table-container table tbody'),
        summary:prepareForFirestore('#summary-container table tbody')
      };
      
      try {
        const response = await fetch(`${RENDER_BACKEND_URL}/api/schedules`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error('Failed to save data');
        btn.innerText=translations[lang].saveSuccess;
      } catch (e) {
        console.error(e);
        btn.innerText=translations[lang].saveFail;
      } finally {
        btn.disabled=false;
        setTimeout(()=>btn.innerText=txt,2000);
      }
    }

    // LOAD from MongoDB
    async function loadScheduleFromMongoDB(){
      const { month, year } = currentMY();
      const url = `${RENDER_BACKEND_URL}/api/schedules/${year}/${month}`;
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to load schedule');
        const doc = await response.json();
        if (!doc || !doc.schedule) return;
        const rows = doc.schedule;
        const tbodyRows = document.querySelectorAll('#table-container table tbody tr');
        tbodyRows.forEach((tr, i) => {
          const rowObj = rows[i];
          if (!rowObj) return;
          Object.keys(rowObj)
            .sort((a, b) => parseInt(a.slice(1)) - parseInt(b.slice(1)))
            .forEach((key, cidx) => {
              const rawVal = rowObj[key];
              const val = (typeof rawVal === 'string')
                ? rawVal.split(/\r?\n/)[0]
                : rawVal;
              const cell = tr.cells[cidx];
              const sel = cell.querySelector('select');
              if (sel) {
                if (shifts.includes(val)) {
                sel.value = val;
                colorShift(cell, val);
              }
              } else if (val && shifts.includes(val)) {
                cell.innerText = val;
                colorShift(cell, val);
              }
            });
        });
        updateSummary();
      } catch(e) {
        console.error('‚ùå Load error', e);
      }
    }

    async function loadEmployeesAndHolidays() {
      try {
        const [empRes, holRes] = await Promise.all([
          fetch(`${RENDER_BACKEND_URL}/api/employees`),
          fetch(`${RENDER_BACKEND_URL}/api/holidays`)
        ]);
        const empData = await empRes.json();
        employees = empData.map(e => e.name); // ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ name ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        const customHolidays = await holRes.json();
        holidays = [...defaultHolidays, ...customHolidays];
      } catch (e) {
        console.error('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', e);
        employees = ["K.Nu", "K.Ning", "K.Chaaem", "K.Som"]; // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ default
        holidays = [...defaultHolidays];
      }
    }

    window.onload = async () => {
      initControls();
      await loadEmployeesAndHolidays();
      initOffInputs();
      bindHolidayControls();
      setTexts();
      redrawAll();
      loadScheduleFromMongoDB();
    };
  </script>
</body>
</html>